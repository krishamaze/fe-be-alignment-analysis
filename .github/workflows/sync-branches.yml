name: Auto-Sync Development Branches

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *'
  repository_dispatch:
    types: [sync-dev-branches]

permissions:
  contents: write

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout analysis repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          submodules: recursive
          fetch-depth: 0
          persist-credentials: true

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Auto-Sync"
          git config --local pull.ff only

      - name: Debug checkout state
        run: |
          echo "Repository root contents:"
          ls -la
          echo "Submodule configuration:"
          cat .gitmodules
          echo "Git submodule status after checkout:"
          git submodule status || echo "No submodules found"

      - name: Verify Repository Access and Branches
        run: |
          echo "Verifying access to backend repository and branch..."
          if ! git ls-remote --exit-code https://github.com/krishamaze/finetune-ERP-backend krishna/implement-phase-a1-admin-api-scaffold; then
            echo "âŒ Cannot access backend repository or branch 'krishna/implement-phase-a1-admin-api-scaffold'. Check if:"
            echo "  - Repository exists and is accessible"
            echo "  - Branch exists in the repository"
            echo "  - Personal Access Token has correct permissions"
            echo "  - Token is not expired"
            exit 1
          fi
          echo "âœ… Backend repository and branch accessible"

          echo "Verifying access to frontend repository and branch..."
          if ! git ls-remote --exit-code https://github.com/krishamaze/finetune-ERP-frontend feature/dashboard-integration; then
            echo "âŒ Cannot access frontend repository or branch 'feature/dashboard-integration'. Check if:"
            echo "  - Repository exists and is accessible"
            echo "  - Branch exists in the repository"
            echo "  - Personal Access Token has correct permissions"
            echo "  - Token is not expired"
            exit 1
          fi
          echo "âœ… Frontend repository and branch accessible"

      - name: Setup submodules (with fallback)
        run: |
          echo "Current submodule status:"
          git submodule status || echo "No submodules initialized"

          echo "Cleaning up any existing submodule state..."
          rm -rf backend frontend || true

          echo "Attempting submodule initialization..."
          git config -f .gitmodules submodule.backend.url \
            https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/krishamaze/finetune-ERP-backend
          git config -f .gitmodules submodule.frontend.url \
            https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/krishamaze/finetune-ERP-frontend

          git submodule sync --recursive
          if ! git submodule update --init --recursive --jobs 4; then
            echo "âš ï¸ Submodule initialization failed, falling back to manual clone..."

            echo "Cloning backend repository..."
            git clone -b krishna/implement-phase-a1-admin-api-scaffold \
              https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/krishamaze/finetune-ERP-backend \
              backend

            echo "Cloning frontend repository..."
            git clone -b feature/dashboard-integration \
              https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/krishamaze/finetune-ERP-frontend \
              frontend

            echo "âœ… Manual clone completed successfully"
          else
            echo "âœ… Submodule initialization successful"
          fi

          echo "Final status:"
          ls -la backend/ frontend/ || echo "Directories not found"

      - name: Sanity check submodule remotes
        run: |
          echo "Checking backend submodule:"
          if [ -d "backend/.git" ]; then
            echo "âœ… Backend is a proper git repository"
            git -C backend remote -v
          else
            echo "âŒ Backend is not a proper git repository"
            ls -la backend/ || echo "Backend directory does not exist"
            exit 1
          fi

          echo "Checking frontend submodule:"
          if [ -d "frontend/.git" ]; then
            echo "âœ… Frontend is a proper git repository"
            git -C frontend remote -v
          else
            echo "âŒ Frontend is not a proper git repository"
            ls -la frontend/ || echo "Frontend directory does not exist"
            exit 1
          fi

      - name: Sync Backend Branch
        run: |
          cd backend
          echo "Current directory: $(pwd)"
          echo "Current branch: $(git branch --show-current)"
          echo "Git remote status:"
          git remote -v

          echo "Fetching latest changes..."
          git fetch origin
          echo "Pulling latest changes..."
          git pull --ff-only
          echo "âœ… Backend synced to: $(git rev-parse --short HEAD)"
          cd ..

      - name: Sync Frontend Branch
        run: |
          cd frontend
          echo "Current directory: $(pwd)"
          echo "Current branch: $(git branch --show-current)"
          echo "Git remote status:"
          git remote -v

          echo "Fetching latest changes..."
          git fetch origin
          echo "Pulling latest changes..."
          git pull --ff-only
          echo "âœ… Frontend synced to: $(git rev-parse --short HEAD)"
          cd ..

      - name: Commit Updates
        run: |
          git add backend frontend
          if ! git diff --staged --quiet; then
            git commit -m "Auto-sync: FE (feature/dashboard-integration) & BE (krishna/implement-phase-a1-admin-api-scaffold) - $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
            echo "âœ… Analysis repo updated with latest changes"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Summary
        run: |
          echo "## ðŸ”„ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Repository**: krishamaze/finetune-ERP-backend" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Branch**: krishna/implement-phase-a1-admin-api-scaffold" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Commit**: \`$(cd backend && git rev-parse --short HEAD)\` - $(cd backend && git log -1 --pretty=format:'%s')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Repository**: krishamaze/finetune-ERP-frontend" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Branch**: feature/dashboard-integration" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Commit**: \`$(cd frontend && git rev-parse --short HEAD)\` - $(cd frontend && git log -1 --pretty=format:'%s')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sync Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: Auto-Sync Development Branches" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Completed Successfully" >> $GITHUB_STEP_SUMMARY
