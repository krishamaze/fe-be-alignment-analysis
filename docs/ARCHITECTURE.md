# System Architecture Explanation

This explanation summarizes how the Finetune ERP platform is composed and how data flows between the backend, frontend, and operational services that support repair shop workflows.

```mermaid
flowchart LR
    subgraph Client
        UI[React Frontend]
    end
    subgraph Django Apps
        Accounts[Accounts & Auth]
        Bookings[Bookings]
        Attendance[Attendance]
        Inventory[Inventory & Spares]
        Invoicing[Invoicing]
        Activity[Activity Logs]
    end
    subgraph Services
        Notifications[Notification Service]
        Commands[Scheduled Management Commands]
    end
    subgraph Data Stores
        DB[(PostgreSQL / SQLite)]
        Media[(Static & Media Storage)]
    end
    UI -- RTK Query / REST --> Accounts
    UI -- Repair Flows --> Bookings
    Accounts --> DB
    Bookings --> DB
    Attendance --> DB
    Inventory --> DB
    Invoicing --> DB
    Activity --> DB
    Notifications -- Email/SMS --> External Channels
    Commands -- Summaries --> Attendance
    Django Apps --> Media
```

## Backend layers

- **Domain apps** – Django apps under `accounts`, `bookings`, `inventory`, `marketing`, `attendance`, `invoicing`, `activity`, and `store` expose REST endpoints through DRF routers. The URLs listed in [API_ROUTES.md](reference/API_ROUTES.md) reflect each registered router or path.
- **Settings & configuration** – Environment variables outlined in [ENVIRONMENT_KEYS.md](reference/ENVIRONMENT_KEYS.md) control secrets, notification channels, and feature toggles. The project defaults to SQLite for local development and switches to PostgreSQL when `DATABASE_URL` points at a managed database.

> [!NOTE]
> Keep router registrations centralized—`scripts/generate_references.py` depends on DRF conventions to keep the reference file accurate.

## Frontend structure

- **Routing** – `src/App.jsx` wires marketing pages, customer-authenticated flows, and admin dashboards with React Router 7. Layout components (`PublicLayout`, `FocusLayout`, `DashboardLayout`) manage responsive breakpoints and share theming.
- **State management** – Redux Toolkit Query (`src/api/erpApi.js`) handles API requests, automatic token refresh, and cache invalidation. Hooks generated by the slice power dashboards, booking forms, and inventory tools.
- **Design system** – Tailwind utility classes and CSS variables in `src/index.css` define colors and spacing. Components must rely on the layout shells to avoid competing layout authorities.

## Background services

- **Notifications** – `NotificationService` sends transactional emails and SMS using templates under `finetune-ERP-backend-New/templates/`.
- **Attendance rollups** – Management commands such as `attendance_autoclose` finalize prior-day attendance and payroll adjustments.
- **Integrations** – Marketing and booking submissions trigger downstream alerts via the notification service and `BOOKING_NOTIFICATION_CHANNELS` configuration.

## Data flow & integration points

1. A customer or internal user triggers an action in the frontend.
2. The frontend sends an authenticated request to the Django API using the RTK Query client.
3. The API validates the request, persists state changes, and triggers any required notifications or management commands.
4. Background jobs (management commands or scheduled scripts) finalize attendance, send reminders, or notify staff as needed.
5. The frontend polls or subscribes to updated state, rendering the latest results.

## Security and observability

- JSON Web Tokens secure dashboard APIs. Refresh/verify routes are published via [API_ROUTES.md](reference/API_ROUTES.md).
- CSP, CORS, and HTTPS settings derive from environment keys to keep deployment-specific overrides in configuration rather than code.
- Audit trails are stored through the `activity` app and exposed under `/api/logs/` for compliance.
